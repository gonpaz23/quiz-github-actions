name: Ejercicio 5

# Variables de entorno globales
env:
  APP_NAME: "Quiz App"
  VERSION: "1.0.0"

on:
  push:
    branches: [ main, development ]
  pull_request:
    branches: [ main ]

jobs:
  # Job 1: Setup
  setup:
    runs-on: ubuntu-latest
    
    # Definir outputs del job
    outputs:
      timestamp: ${{ steps.create-timestamp.outputs.timestamp }}
    
    steps:
      # Step 1: Imprimir variables globales
      - name: Mostrar configuraciÃ³n
        run: |
          echo "AplicaciÃ³n: $APP_NAME"
          echo "VersiÃ³n: $VERSION"
          echo "Evento: ${{ github.event_name }}"
          echo "Rama: ${{ github.ref }}"
      
      # Step 2: Crear output con timestamp
      - name: Crear timestamp
        id: create-timestamp  # ID necesario para el output
        run: echo "timestamp=$(date +%s)" >> $GITHUB_OUTPUT

  # Job 2: Tests
  test:
    needs: setup  # Depende del job setup
    runs-on: ubuntu-latest
    
    # Variable de entorno especÃ­fica del job
    env:
      NODE_ENV: test
    
    steps:
      # Step 1: Checkout del cÃ³digo
      - name: Checkout cÃ³digo
        uses: actions/checkout@v4
      
      # Step 2: Configurar Node.js
      - name: Configurar Node.js 18
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
      
      # Step 3: Instalar dependencias
      - name: Instalar dependencias
        run: npm ci
      
      # Step 4: Mostrar timestamp del job anterior
      - name: Mostrar timestamp del setup
        run: |
          echo "Timestamp del job setup: ${{ needs.setup.outputs.timestamp }}"
          echo "Entorno: $NODE_ENV"
      
      # Step 5: Ejecutar tests
      - name: Ejecutar tests
        run: npm test

  # Job 3: Deploy (solo en main)
  deploy:
    needs: test  # Depende del job test
    runs-on: ubuntu-latest
    
    # Condicional: solo ejecutar en la rama main
    if: github.ref == 'refs/heads/main'
    
    # Variable de entorno con secret
    env:
      API_KEY: ${{ secrets.API_KEY }}
    
    steps:
      # Step 1: Imprimir informaciÃ³n del deploy
      - name: InformaciÃ³n del deploy
        run: |
          echo "ðŸš€ Desplegando $APP_NAME v$VERSION"
          echo "Commit: ${{ github.sha }}"
          echo "Autor: ${{ github.actor }}"
      
      # Step 2: Verificar secret (sin mostrar el valor)
      - name: Verificar secret configurada
        if: env.API_KEY != ''
        run: |
          echo "âœ… Secret API_KEY configurada correctamente"
          echo "Longitud de la secret: ${#API_KEY} caracteres"
        # NOTA: Nunca imprimas el valor real: echo "$API_KEY"
      
      # Step 3: Mostrar error si no estÃ¡ configurada
      - name: Error si no hay secret
        if: env.API_KEY == ''
        run: |
          echo "âŒ ERROR: Secret API_KEY no estÃ¡ configurada"
          echo "Por favor, configura el secret en Settings > Secrets > Actions"
          exit 1